<?php
if (!defined('ABSPATH')) exit;

class PPV_POS_Admin {

    /** ============================================================
     * INIT
     * ============================================================ */
    public static function hooks() {
        add_shortcode('ppv_pos_admin', [__CLASS__, 'render_shortcode']);
        add_action('wp_enqueue_scripts', [__CLASS__, 'enqueue_assets']);
    }

    /** ============================================================
     /** ============================================================
 *  ASSETS (CSS + JS)
 *  ============================================================ */
public static function enqueue_assets() {
    // csak akkor tÃ¶ltsÃ¼k be, ha shortcode az oldalon van
    if (!is_singular()) return;
    global $post;
    if (has_shortcode($post->post_content, 'ppv_pos_admin')) {

        // ğŸ”¹ CSS betÃ¶ltÃ©s
        wp_enqueue_style(
            'ppv-pos-admin',
            PPV_PLUGIN_URL . 'assets/css/ppv-pos-admin.css',
            [],
            time()
        );

        // ğŸ”¹ JS betÃ¶ltÃ©s
        wp_enqueue_script(
            'ppv-pos-admin',
            PPV_PLUGIN_URL . 'assets/js/ppv-pos-admin.js',
            ['jquery'],
            time(),
            true
        );

        // ğŸ”¹ RÃ©gi lokalizÃ¡ciÃ³ (logout, log funkciÃ³khoz)
        wp_localize_script('ppv-pos-admin', 'PPV_POS_ADMIN', [
            'resturl' => trailingslashit(esc_url(rest_url('ppv/v1/'))),
            'nonce'   => wp_create_nonce('wp_rest'),
        ]);

        // ğŸ”¹ Ãšj lokalizÃ¡ciÃ³ a statisztikÃ¡hoz Ã©s dashboardhoz
        wp_localize_script('ppv-pos-admin', 'PPV_POS', [
            'api_base' => esc_url(rest_url('ppv/v1')),
            'store_id' => get_current_user_id() ? intval(get_user_meta(get_current_user_id(), 'store_id', true)) : 0,
        ]);
    }
}


    /** ============================================================
     * SHORTCODE MEGJELENÃTÃ‰S ([ppv_pos_admin])
     * ============================================================ */
public static function render_shortcode() {
    
    


        ob_start();
        ?>
        <div id="ppv-pos-wrapper" class="ppv-pos-container">
            <div id="ppv-pos-login" class="ppv-pos-card">
                <h2>ğŸ’³ POS Login</h2>
                <p>Bitte geben Sie den PIN ein, um sich anzumelden.</p>
                <input type="password" id="ppv-pos-pin" placeholder="PIN eingeben">
                <button id="ppv-pos-login-btn" class="ppv-btn-primary">Anmelden</button>
                <div id="ppv-pos-login-msg" class="ppv-msg"></div>
                
                
            </div>

            <div id="ppv-pos-dashboard" style="display:none;">
    <?php echo self::render_pos_dashboard(); ?>
</div>

        </div>
        <?php
        
    if (!isset($_COOKIE['ppv_pos_token'])) {
    ?>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('ppv-pos-dashboard').style.display = 'none';
        document.getElementById('ppv-pos-login').style.display = 'block';
      });
    </script>
    <?php
}

        return ob_get_clean();
    }
    
   public static function render_pos_dashboard() {
    ob_start(); ?>
    
    <div id="ppv-pos-dashboard" class="ppv-pos-dashboard">
        <h2>ğŸ“Š POS Dashboard</h2>
        <p>Willkommen, <span id="ppv-store-name">Lade...</span></p>
        <div class="ppv-store-switcher">
  <label for="ppv-store-selector">ğŸ›ï¸ GeschÃ¤ft wÃ¤hlen:</label>
  <select id="ppv-store-selector" class="ppv-select"></select>
</div>


        <div class="ppv-pos-cards">
            <div class="ppv-pos-card">
                <span>ğŸ“ˆ Heutige Scans:</span>
                <strong id="today-scans">0</strong>
            </div>

            <div class="ppv-pos-card">
                <span>ğŸ’° Heutige Punkte:</span>
                <strong id="today-points">0</strong>
            </div>

            <div class="ppv-pos-card">
                <span>ğŸ Heutige Rewards:</span>
                <strong id="today-rewards">0</strong>
            </div>

            <div class="ppv-pos-card">
                <span>ğŸ“£ Aktive Kampagnen:</span>
                <strong id="active-campaigns">0</strong>
            </div>

            <div class="ppv-pos-card">
                <span>ğŸ’¶ Heutiger Umsatz (â‚¬):</span>
                <strong id="today-sales">0.00</strong>
            </div>

            <div class="ppv-pos-card">
                <span>ğŸ•’ Letzter Scan:</span>
                <strong id="last-scan">â€”</strong>
            </div>
        </div>

        <!-- ğŸ“Š Diagrambereich -->
        <div class="ppv-pos-chart-wrapper" style="margin-top:25px;">
            <canvas id="posChart" style="width:100%;height:220px;"></canvas>
        </div>

        <div class="ppv-pos-buttons" style="margin-top:25px;display:flex;gap:10px;justify-content:center;">
            <button id="ppv-pos-refresh" class="ppv-btn-refresh">ğŸ”„ Aktualisieren</button>
            <button id="ppv-pos-logout-btn" class="ppv-btn-logout">ğŸšª Logout</button>
        </div>
    </div>

    <?php
    return ob_get_clean();
}

}


/** ============================================================
 * REST API VÃ‰GPONTOK
 * ============================================================ */
add_action('rest_api_init', function() {
    register_rest_route('ppv/v1', '/pos/login', [
        'methods'  => 'POST',
        'callback' => function($request) {
            global $wpdb;
            $pin = sanitize_text_field($request['pin'] ?? '');
            if (!$pin) {
                return new WP_REST_Response(['success' => false, 'message' => 'PIN fehlt.'], 400);
            }

            $store = $wpdb->get_row($wpdb->prepare("
    SELECT id, name, pos_enabled, active, subscription_status 
    FROM {$wpdb->prefix}ppv_stores 
    WHERE pos_pin = %s LIMIT 1
", $pin));

if (
    !$store ||
    empty($store->pos_enabled) ||
    empty($store->active) ||
    $store->subscription_status !== 'active'


) {
    error_log("ğŸš« [POS_Login] UngÃ¼ltiger oder inaktiver Store-PIN: {$pin}");
    return new WP_REST_Response(['success' => false, 'message' => 'Dieser HÃ¤ndler ist nicht aktiviert oder der POS ist deaktiviert.'], 403);
}


            $token = wp_generate_uuid4();
            set_transient("ppv_pos_session_{$token}", $store->id, HOUR_IN_SECONDS * 6);

            return [
                'success' => true,
                'data' => [
                    'store_id' => intval($store->id),
                    'store_name' => $store->name,
                    'session_token' => $token,
                ]
            ];
        },
        'permission_callback' => '__return_true'
    ]);

    register_rest_route('ppv/v1', '/pos/status', [
        'methods'  => 'POST',
        'callback' => function($request) {
            global $wpdb;
            $token = sanitize_text_field($request['token'] ?? '');
            $store_id = get_transient("ppv_pos_session_{$token}");
            if (!$store_id) {
                return new WP_REST_Response(['success' => false, 'message' => 'Session abgelaufen.'], 401);
            }

            $stats = [
                'scans_today' => (int) $wpdb->get_var($wpdb->prepare("
                    SELECT COUNT(*) FROM {$wpdb->prefix}ppv_points
                    WHERE store_id = %d AND DATE(created_at) = CURDATE()
                ", $store_id)),
                'rewards_today' => (int) $wpdb->get_var($wpdb->prepare("
                    SELECT COUNT(*) FROM {$wpdb->prefix}ppv_rewards_log
                    WHERE store_id = %d AND DATE(created_at) = CURDATE()
                ", $store_id)),
                'campaigns' => (int) $wpdb->get_var($wpdb->prepare("
                    SELECT COUNT(*) FROM {$wpdb->prefix}ppv_campaigns
                    WHERE store_id = %d AND active = 1
                ", $store_id)),
            ];

            return [
                'success' => true,
                'data' => $stats
            ];
        },
        'permission_callback' => '__return_true'
    ]);

    register_rest_route('ppv/v1', '/pos/logout', [
        'methods'  => 'POST',
        'callback' => function($request) {
            $token = sanitize_text_field($request['token'] ?? '');
            if ($token) {
                delete_transient("ppv_pos_session_{$token}");
            }
            return ['success' => true, 'message' => 'Abgemeldet'];
        },
        'permission_callback' => '__return_true'
        
    ]);
    
    
});


/** ============================================================
 * HOOK AKTIVÃLÃS
 * ============================================================ */
add_action('plugins_loaded', function () {
    PPV_POS_Admin::hooks();
    error_log("âœ… PPV_POS_Admin (Frontend) aktiv â€“ Shortcode [ppv_pos_admin]");
});
